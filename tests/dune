(executable
 (name extract_tests)
 (libraries str)
 (modules extract_tests))

;  Generate and run tests for the core omd package
(rule
 (with-stdout-to
  dune.inc.new
  (run ./extract_tests.exe -write-dune-file
       %{dep:spec.txt}
       %{dep:attributes.md}
       %{dep:def_list.md})))

(include dune.inc)

(executable
 (name omd_tyxml)
 (libraries str omd tyxml omd_tyxml)
 (modules omd_tyxml))

;  Generate and run tests for the optional omd-tyxml package
(rule
 (with-stdout-to dune-omd-tyxml.inc.new (run ./extract_tests.exe -write-dune-file-omd-tyxml)))

(include dune-omd-tyxml.inc)

(executable
 (name omd)
 (libraries str omd)
 (modules omd))

;  Generate the rules for diff-based tests
(rule
 (alias gen)
 (action
  (progn
    (diff dune.inc dune.inc.new)
    (diff dune-omd-tyxml.inc dune-omd-tyxml.inc.new))))
